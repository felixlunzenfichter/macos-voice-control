<!DOCTYPE html>
<html>
<head>
    <!-- Standard HTML5 document type and UTF-8 character encoding -->
    <meta charset="UTF-8">
    <title>Git Client UI</title>
    
    <!-- ==================================================================================== -->
    <!-- CSS STYLES - Newspaper Column Layout for Git Output Display -->
    <!-- ==================================================================================== -->
    <style>
        /* GLOBAL RESET - Remove all default browser margins/padding */
        * {
            margin: 0;                    /* Remove default margins */
            padding: 0;                   /* Remove default padding */
            box-sizing: border-box;       /* Include padding/border in element width/height */
        }

        /* MAIN BODY STYLING - Fullscreen dark terminal appearance */
        body {
            width: 100vw;                 /* Full viewport width */
            height: 100vh;                /* Full viewport height */
            background: black;            /* Black terminal background */
            color: rgb(255, 100, 0);     /* Orange text (terminal-style) */
            font-family: monospace;       /* Fixed-width font for code display */
            font-size: 13px;              /* Small readable font size */
            overflow: hidden;             /* Hide any scrollbars on body */
        }

        /* CONTENT CONTAINER - Horizontal scrolling newspaper layout */
        #content {
            width: 100%;                  /* Full width of window */
            height: 100vh;                /* Full height of window */
            display: flex;                /* Horizontal flexbox layout */
            gap: 20px;                    /* 20px space between columns */
            padding: 10px;                /* 10px padding around entire content */
            overflow-x: auto;             /* Allow horizontal scrolling for many columns */
            overflow-y: hidden;           /* No vertical scrolling (columns handle height) */
            scroll-behavior: auto;        /* DISABLE smooth scrolling - instant jumps */
            
            /* HIDE SCROLLBARS - Keep clean appearance while allowing scroll */
            scrollbar-width: none;        /* Firefox: hide scrollbar */
            -ms-overflow-style: none;     /* IE/Edge: hide scrollbar */
        }
        
        /* WEBKIT SCROLLBAR HIDING - Chrome/Safari */
        #content::-webkit-scrollbar {
            display: none;                /* Chrome/Safari: hide scrollbar */
        }
        
        /* COLUMN STYLING - Each column shows 64 lines of git output */
        .column {
            flex: none;                   /* Don't grow/shrink columns */
            width: min-content;           /* Width determined by longest line in column */
            height: 100%;                 /* Full height of container */
            overflow-y: hidden;           /* No vertical scrolling within columns */
            overflow-x: visible;          /* Allow long lines to determine column width */
            padding-right: 20px;          /* Space before border */
            border-right: 1px solid rgb(40, 0, 0);  /* Dark red column separator */
            white-space: pre;             /* Preserve all whitespace and formatting */
        }
        
        /* LAST COLUMN - Remove right border for clean edge */
        .column:last-child {
            border-right: none;           /* No border on rightmost column */
        }

        /* LINE STYLING - Individual lines of git output */
        .line {
            margin: 1px 0;                /* Small vertical spacing between lines */
            overflow: visible;            /* Allow line content to determine column width */
            text-overflow: clip;          /* Cut off extremely long lines cleanly */
        }

        /* SECTION HEADER STYLING - Center the section titles */
        .section-header {
            text-align: center;           /* Center the section headers */
            font-weight: bold;            /* Make section headers bold */
        }

        /* COLUMN NUMBER STYLING - Show column numbers at top */
        .column-number {
            text-align: center;           /* Center the column number */
            font-weight: bold;            /* Make column numbers bold */
            color: rgb(100, 100, 100);    /* Darker gray for subtle appearance */
            margin-bottom: 5px;           /* Small space below column number */
            font-size: 11px;              /* Slightly smaller font */
        }



    </style>
</head>
<body>
    <!-- MAIN CONTENT CONTAINER - JavaScript will populate this with git data -->
    <div id="content">
        <!-- Content will be generated by JavaScript -->
    </div>

    <!-- ==================================================================================== -->
    <!-- JAVASCRIPT - Git Repository Monitor and Display Engine -->
    <!-- ==================================================================================== -->
    <script>
        // ====================================================================================
        // LOGGING HELPER
        // ====================================================================================
        function log(message) {
            if (window.electronAPI && window.electronAPI.logMessage) {
                window.electronAPI.logMessage(message);
            }
        }
        
        // ====================================================================================
        // CONFIGURATION VARIABLES
        // ====================================================================================
        const LINES_PER_COLUMN = 58;  // Number of lines per newspaper column (easily configurable)
        
        // ====================================================================================
        // GIT COMMAND EXECUTION FUNCTIONS
        // ====================================================================================
        // These functions execute git commands via Electron's secure IPC bridge
        
        // FETCH GIT STATUS - Get list of changed/untracked files
        async function fetchGitStatus() {
            try {
                // Execute 'git status --porcelain' for machine-readable status
                // --porcelain flag gives consistent format: "XY filename"
                // where X=staged status, Y=unstaged status
                const result = await window.electronAPI?.executeCommand('git status --porcelain') || 
                              await executeShellCommand('git status --porcelain');
                              
                // Split by newlines and filter out empty lines
                return result.trim().split('\n').filter(line => line.trim());
            } catch (error) {
                log(`Error fetching git status: ${error}`);
                return [];  // Return empty array on error to prevent crashes
            }
        }


        // FETCH BRANCH INFORMATION - Get current branch and remote tracking info
        async function fetchBranchInfo() {
            try {
                // Get current branch name
                const branch = await window.electronAPI?.executeCommand('git branch --show-current') ||
                              await executeShellCommand('git branch --show-current');
                              
                // Count commits ahead of upstream (local commits not pushed)
                // 2>/dev/null suppresses error if no upstream exists
                // || echo "0" provides fallback value
                const ahead = await window.electronAPI?.executeCommand('git rev-list --count HEAD@{upstream}..HEAD 2>/dev/null || echo "0"') ||
                             await executeShellCommand('git rev-list --count HEAD@{upstream}..HEAD 2>/dev/null || echo "0"');
                             
                // Count commits behind upstream (remote commits not pulled)
                const behind = await window.electronAPI?.executeCommand('git rev-list --count HEAD..HEAD@{upstream} 2>/dev/null || echo "0"') ||
                              await executeShellCommand('git rev-list --count HEAD..HEAD@{upstream} 2>/dev/null || echo "0"');
                
                return {
                    branch: branch.trim(),              // Current branch name
                    ahead: parseInt(ahead.trim()) || 0, // Commits ahead of remote
                    behind: parseInt(behind.trim()) || 0 // Commits behind remote
                };
            } catch (error) {
                log(`Error fetching branch info: ${error}`);
                return { branch: 'unknown', ahead: 'unknown', behind: 'unknown' };  // Safe fallback
            }
        }

        // FETCH RECENT COMMITS - Get last 5 commit messages for context
        async function fetchRecentCommits() {
            try {
                // Get last 5 commits with just the subject line (%s)
                // --pretty=format:"%s" shows only commit messages
                // -5 limits to 5 most recent commits
                const result = await window.electronAPI?.executeCommand('git log --pretty=format:"%s" -5') ||
                              await executeShellCommand('git log --pretty=format:"%s" -5');
                              
                // Split into array, filter empty lines, add numbering
                return result.trim().split('\n').filter(line => line.trim())
                    .map((commit, index) => `${index + 1}. ${commit}`);
            } catch (error) {
                log(`Error fetching commits: ${error}`);
                return [];  // Return empty array on error
            }
        }

        // FALLBACK COMMAND EXECUTION - For non-Electron environments
        async function executeShellCommand(command) {
            return new Promise((resolve, reject) => {
                // This function provides fallback structure for non-Electron environments
                // In browser context, this won't actually execute commands
                // Always resolves with empty string to prevent errors
                resolve('');
            });
        }

        // GET REPOSITORY NAME - Extract repository name from git config or directory
        async function getRepositoryName() {
            try {
                // Try to get repository name from git config (origin URL)
                const remoteUrl = await window.electronAPI?.executeCommand('git config --get remote.origin.url') ||
                                 await executeShellCommand('git config --get remote.origin.url');
                
                if (remoteUrl && remoteUrl.trim()) {
                    // Extract repository name from URL
                    // Examples: 
                    // https://github.com/user/repo.git -> repo
                    // git@github.com:user/repo.git -> repo
                    const match = remoteUrl.trim().match(/\/([^\/]+?)(?:\.git)?$/);
                    if (match && match[1]) {
                        return match[1];
                    }
                }
                
                // Fallback: use current directory name
                const pwd = await window.electronAPI?.executeCommand('pwd') ||
                           await executeShellCommand('pwd');
                           
                if (pwd && pwd.trim()) {
                    const dirPath = pwd.trim();
                    const dirName = dirPath.split('/').pop();
                    return dirName || 'unknown-repo';
                }
                
                return 'unknown-repo';
            } catch (error) {
                log(`Error getting repository name: ${error}`);
                return 'unknown-repo';
            }
        }


        // ====================================================================================
        // MAIN CONTENT GENERATION FUNCTION
        // ====================================================================================
        // This function fetches all git data and creates the newspaper column layout
        
        async function generateContent(forceRebuild = false) {
            // Get reference to main content container
            const content = document.getElementById('content');
            
            // If content exists and this isn't a forced rebuild, try in-place update
            if (!forceRebuild && content.children.length > 0) {
                await updateContentInPlace();
                return;
            }
            
            content.innerHTML = '<div>Loading git data...</div>';  // Show loading message
            
            try {
                // FETCH ALL GIT DATA IN PARALLEL - More efficient than sequential requests
                const [statusLines, branchInfo, commits] = await Promise.all([
                    fetchGitStatus(),      // Get file status (modified, untracked, etc.)
                    fetchBranchInfo(),     // Get branch name and upstream info  
                    fetchRecentCommits()   // Get last 5 commit messages
                ]);

                // BUILD COMPLETE GIT OUTPUT - Combine all git information
                const allGitContent = [];
                
                // SECTION 1: GIT STATUS - Show all file changes at a glance
                const status = await window.electronAPI?.executeCommand('git status --porcelain') || '';
                if (status.trim()) {
                    allGitContent.push('');                          // Blank line before section
                    allGitContent.push('=== STATUS ===');           // Section header
                    allGitContent.push('');                          // Blank line after header
                    allGitContent.push(...status.split('\n'));      // Each file status line (no spacing between)
                    allGitContent.push('');                          // Blank line after section
                }
                
                // SECTION 2: UNSTAGED CHANGES - Show uncommitted file modifications
                const unstagedDiff = await window.electronAPI?.executeCommand('git diff') || '';
                if (unstagedDiff.trim()) {
                    allGitContent.push('');                          // Blank line before section
                    allGitContent.push('=== UNSTAGED CHANGES ==='); // Section header
                    allGitContent.push('');                          // Blank line after header
                    allGitContent.push(...unstagedDiff.split('\n')); // Raw diff output
                    allGitContent.push('');                          // Blank line after section
                }

                // SECTION 3: STAGED CHANGES - Show changes ready for commit
                const stagedDiff = await window.electronAPI?.executeCommand('git diff --cached') || '';
                if (stagedDiff.trim()) {
                    allGitContent.push('');                          // Blank line before section
                    allGitContent.push('=== STAGED CHANGES ===');   // Section header
                    allGitContent.push('');                          // Blank line after header
                    allGitContent.push(...stagedDiff.split('\n'));  // Raw diff output of staged files
                    allGitContent.push('');                          // Blank line after section
                }

                // EXTRACT FILENAMES FROM GIT DIFF - Get list of files being changed
                const changedFiles = [];
                const allDiffContent = [unstagedDiff, stagedDiff].join('\n');
                const diffLines = allDiffContent.split('\n');
                
                // Log to file without blocking
                window.electronAPI?.executeCommand(`echo "${new Date().toISOString()} - Searching ${diffLines.length} diff lines for filenames" >> /tmp/git-client.log`);
                
                for (const line of diffLines) {
                    // Look for git diff file headers like "diff --git a/file.js b/file.js"
                    if (line.startsWith('diff --git')) {
                        window.electronAPI?.executeCommand(`echo "${new Date().toISOString()} - Found diff line: ${line}" >> /tmp/git-client.log`);
                        
                        const match = line.match(/diff --git a\/(.+?) b\//);
                        if (match && match[1]) {
                            // Extract just the filename after the last slash
                            const fullPath = match[1];
                            const filename = fullPath.split('/').pop();
                            window.electronAPI?.executeCommand(`echo "${new Date().toISOString()} - Extracted filename: ${filename}" >> /tmp/git-client.log`);
                            changedFiles.push(filename);
                        }
                    }
                }
                
                // CREATE HEADER INFORMATION - Summary info displayed at top
                const fileInfo = changedFiles.length > 0 ? 
                    `Files: ${changedFiles.slice(0, 3).join(', ')}${changedFiles.length > 3 ? ' +' + (changedFiles.length - 3) + ' more' : ''}` :
                    'No file changes';
                    
                window.electronAPI?.executeCommand(`echo "${new Date().toISOString()} - Header file info: ${fileInfo}" >> /tmp/git-client.log`);
                    
                // GET REPOSITORY NAME - Extract from current working directory or git config
                const repoName = await getRepositoryName();
                
                // Read CURRENT_COMMIT.md and TODO.md files
                const currentCommitContent = await window.electronAPI?.executeCommand('cat CURRENT_COMMIT.md') || '';
                const todoContent = await window.electronAPI?.executeCommand('cat TODO.md') || '';

                const headerLines = [
                    `Repository: ${repoName} | Lines per column: ${LINES_PER_COLUMN}`, // Repository name and settings
                    `Branch: ${branchInfo.branch} | Ahead: ${branchInfo.ahead} | Behind: ${branchInfo.behind}`, // Git status
                    'COMMIT HISTORY',
                    'Current Commit:',
                    ...currentCommitContent.split('\n'),
                    '',
                    ...commits,
                    '',
                    'TODO List:',
                    ...todoContent.split('\n')
                ];
                
                // Log exactly what header content is being set
                window.electronAPI?.executeCommand(`echo "${new Date().toISOString()} - HEADER LINES CREATED:" >> /tmp/git-client.log`);
                headerLines.forEach((line, index) => {
                    window.electronAPI?.executeCommand(`echo "${new Date().toISOString()} - Header line ${index}: ${line}" >> /tmp/git-client.log`);
                });

                // CLEAR CONTENT AND START BUILDING COLUMNS
                content.innerHTML = '';
                
                // MEASURE LINE HEIGHT - Needed for calculating column layout
                const testLine = document.createElement('div');
                testLine.className = 'line';                        // Use same styling as real lines
                testLine.innerHTML = '<span class="line-number">1:</span>Test';  // Sample content
                testLine.style.visibility = 'hidden';              // Hide from user
                testLine.style.position = 'absolute';              // Don't affect layout
                document.body.appendChild(testLine);               // Add to DOM for measurement
                
                const lineHeight = testLine.getBoundingClientRect().height;  // Get actual height
                document.body.removeChild(testLine);               // Clean up test element
                
                const containerHeight = content.clientHeight;      // Get available display height
                const linesPerColumn = LINES_PER_COLUMN;            // Use configurable setting
                
                // DEBUG OUTPUT - Log layout calculations
                log(`Container: ${containerHeight}px, Line: ${lineHeight}px, Per column: ${linesPerColumn}`);
                
                // CALCULATE COLUMN LAYOUT
                const totalLines = headerLines.length + allGitContent.length;  // Total content lines
                const columnCount = Math.ceil(totalLines / linesPerColumn);     // How many columns needed
                
                // CREATE COLUMN ELEMENTS
                const columns = [];
                for (let i = 0; i < columnCount; i++) {
                    const column = document.createElement('div');
                    column.className = 'column';                    // Apply column CSS styling
                    columns.push(column);                           // Store reference
                    content.appendChild(column);                    // Add to page
                }
                
                // DISTRIBUTE CONTENT ACROSS COLUMNS
                for (let i = 1; i <= totalLines; i++) {
                    // Calculate which column this line belongs in
                    const columnIndex = Math.floor((i - 1) / linesPerColumn);
                    
                    if (columnIndex < columns.length) {
                        // Create line element
                        const line = document.createElement('div');
                        line.className = 'line';                    // Apply line CSS styling
                        
                        let codeContent;
                        if (i <= headerLines.length) {
                            // HEADER SECTION - Display as-is without line numbers (normal color)
                            codeContent = headerLines[i - 1];
                            line.textContent = codeContent;         // Use textContent to prevent HTML rendering
                        } else {
                            // GIT CONTENT SECTION - Display raw git output
                            const gitIndex = i - headerLines.length - 1;
                            if (gitIndex < allGitContent.length) {
                                codeContent = allGitContent[gitIndex];
                                
                                if (codeContent === '') {
                                    line.textContent = ' ';         // Use space for visual gaps between sections
                                } else if (codeContent.startsWith('=== ') && codeContent.endsWith(' ===')) {
                                    // SECTION HEADERS - Apply centered styling
                                    line.textContent = codeContent; // Display section header text
                                    line.classList.add('section-header'); // Apply centered styling
                                } else {
                                    line.textContent = codeContent; // Display git output as raw text
                                }
                            }
                        }
                        columns[columnIndex].appendChild(line);     // Add line to appropriate column
                    }
                }
                
                // DEBUG OUTPUT - Log generation results
                // ADD COLUMN NUMBERS WITH FLOWING STAGE DETECTION AND FILENAMES
                let currentStage = ''; // Track current section we're in
                let currentFile = ''; // Track current file being shown
                
                columns.forEach((column, index) => {
                    // Check if this column contains section headers or file changes
                    const lines = column.querySelectorAll('.line');
                    
                    for (const line of lines) {
                        const text = line.textContent.trim();
                        if (text === '=== UNSTAGED CHANGES ===') {
                            currentStage = 'UNSTAGED'; // Switch to unstaged section
                        } else if (text === '=== STAGED CHANGES ===') {
                            currentStage = 'STAGED';   // Switch to staged section
                        } else if (text.startsWith('diff --git a/')) {
                            // Extract filename from diff header
                            const match = text.match(/diff --git a\/(.+?) b\//);
                            if (match && match[1]) {
                                currentFile = match[1].split('/').pop(); // Get just filename
                            }
                        }
                    }
                    
                    // Build stage indicator based on current flowing section
                    let stageIndicator = '';
                    if (currentStage === 'UNSTAGED') {
                        stageIndicator = ' | UNSTAGED';
                    } else if (currentStage === 'STAGED') {
                        stageIndicator = ' | STAGED';
                    }
                    
                    // Add filename to column header if we have one for this column
                    let filenameInfo = '';
                    if (currentFile) {
                        filenameInfo = ` | ${currentFile}`;
                    }
                    
                    // Add column number with stage info and filename at the top
                    const columnNumber = document.createElement('div');
                    columnNumber.className = 'column-number';
                    columnNumber.textContent = `${index + 1}${stageIndicator}${filenameInfo}`;
                    
                    // Log column header
                    window.electronAPI?.executeCommand(`echo "${new Date().toISOString()} - Column ${index + 1}: ${columnNumber.textContent}" >> /tmp/git-client.log`);
                    
                    column.insertBefore(columnNumber, column.firstChild); // Insert at very top
                });
                
                log(`Generated ${columns.length} columns with real git data`);
                log(`Total content lines: ${allGitContent.length}`);
                log(`Lines 60-80 of content: ${allGitContent.slice(60, 80).join(', ')}`);
                
                // DEBUG COLUMN ANALYSIS - Check column widths and content after layout
                setTimeout(() => {
                    columns.forEach((col, i) => {
                        const width = col.getBoundingClientRect().width;    // Actual rendered width
                        const lineCount = col.querySelectorAll('.line').length;  // Lines in this column
                        log(`Column ${i+1}: ${Math.round(width)}px wide, ${lineCount} lines`);
                        
                        // Find longest line in this column (affects column width)
                        let longestLine = '';
                        col.querySelectorAll('.line').forEach(line => {
                            if (line.innerHTML.length > longestLine.length) {
                                longestLine = line.innerHTML;
                            }
                        });
                        if (longestLine.length > 100) {
                            log(`Column ${i+1} longest line (${longestLine.length} chars): ${longestLine.substring(0, 100)}...`);
                        }
                    });
                    
                }, 100);  // Small delay to ensure layout is complete
                
                // ADD DIRECTIONAL COLUMN JUMPING - Enable immediate column jumping on scroll
                setTimeout(() => {
                    const content = document.getElementById('content');
                    lastScrollLeft = content.scrollLeft; // Initialize reference position
                    content.addEventListener('scroll', handleDirectionalScroll);
                    log('📍 Directional column jumping enabled');
                }, 200);
                
            } catch (error) {
                log(`Error generating content: ${error}`);
                content.innerHTML = '<div class="error">Error loading git data</div>';  // Error fallback
            }
        }

        // ====================================================================================
        // COLUMN NAVIGATION FUNCTIONS
        // ====================================================================================
        // Handle discrete column-by-column navigation instead of smooth scrolling
        
        // JUMP TO SPECIFIC COLUMN - Instant navigation to column index
        function jumpToColumn(columnIndex) {
            const content = document.getElementById('content');
            const columns = content.querySelectorAll('.column');
            
            if (columnIndex >= 0 && columnIndex < columns.length) {
                const targetColumn = columns[columnIndex];
                const columnLeft = targetColumn.offsetLeft - 10; // Account for padding
                content.scrollLeft = columnLeft;
                currentColumn = columnIndex;
                log(`📍 Jumped to column ${columnIndex + 1}/${columns.length}`);
            } else {
                // Column doesn't exist, jump to last available column
                const lastColumn = Math.max(0, columns.length - 1);
                if (columns.length > 0) {
                    jumpToColumn(lastColumn);
                    log(`⚠️ Column ${columnIndex + 1} doesn't exist, jumped to column ${lastColumn + 1}/${columns.length}`);
                }
            }
        }
        
        // DETECT CURRENT COLUMN - Figure out which column user is viewing
        function detectCurrentColumn() {
            const content = document.getElementById('content');
            const columns = content.querySelectorAll('.column');
            const scrollLeft = content.scrollLeft;
            
            // Find which column is closest to the current scroll position
            let closestColumn = 0;
            let closestDistance = Infinity;
            
            columns.forEach((column, index) => {
                const columnLeft = column.offsetLeft - 10; // Account for padding
                const distance = Math.abs(scrollLeft - columnLeft);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestColumn = index;
                }
            });
            
            currentColumn = closestColumn;
            return closestColumn;
        }
        
        // DIRECTIONAL COLUMN JUMPING - Jump immediately based on scroll direction
        let lastScrollLeft = 0;
        let scrollDebounce = false;
        
        function handleDirectionalScroll() {
            if (scrollDebounce) return; // Prevent rapid firing
            
            const content = document.getElementById('content');
            const currentScrollLeft = content.scrollLeft;
            const scrollDelta = currentScrollLeft - lastScrollLeft;
            
            // Only trigger if scroll is significant (> 10px to avoid tiny movements)
            if (Math.abs(scrollDelta) > 10) {
                const columns = content.querySelectorAll('.column');
                let targetColumn = currentColumn;
                
                if (scrollDelta > 0) {
                    // SCROLLING RIGHT - Jump to next column
                    targetColumn = Math.min(currentColumn + 1, columns.length - 1);
                } else {
                    // SCROLLING LEFT - Jump to previous column  
                    targetColumn = Math.max(currentColumn - 1, 0);
                }
                
                // Jump to target column
                jumpToColumn(targetColumn);
                
                // Brief debounce to prevent rapid firing
                scrollDebounce = true;
                setTimeout(() => {
                    scrollDebounce = false;
                    lastScrollLeft = content.scrollLeft; // Update reference position
                }, 50);
            }
        }

        
        // ====================================================================================
        // GIT CHANGE DETECTION AND MONITORING SYSTEM
        // ====================================================================================
        // Complete system for detecting git repository changes and updating the display
        
        let currentColumn = 0;     // Track which column user is viewing (0-based index)
        
        // PLAY NOTIFICATION SOUND - Japanese gong bell using Web Audio API
        function playNotificationBell() {
            try {
                // Create audio context (required for Web Audio API)
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // CREATE OSCILLATORS - Two sine waves for rich gong sound
                const oscillator1 = audioContext.createOscillator();  // Primary tone
                const oscillator2 = audioContext.createOscillator();  // Harmonic tone
                const gainNode = audioContext.createGain();           // Volume control
                
                // CONNECT AUDIO NODES - Route oscillators through gain to speakers
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // SET FREQUENCIES - Musical intervals that sound like a gong
                oscillator1.frequency.setValueAtTime(220, audioContext.currentTime); // A3 fundamental
                oscillator2.frequency.setValueAtTime(330, audioContext.currentTime); // E4 (perfect fifth)
                
                // SET WAVEFORM - Sine waves produce pure, bell-like tones
                oscillator1.type = 'sine';
                oscillator2.type = 'sine';
                
                // ENVELOPE - Long resonant fade mimics real gong decay
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);                    // Start volume
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 2.5); // Fade over 2.5 seconds
                
                // START AND STOP OSCILLATORS
                oscillator1.start(audioContext.currentTime);         // Begin playback immediately
                oscillator2.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 2.5);    // Stop after 2.5 seconds
                oscillator2.stop(audioContext.currentTime + 2.5);
                
                log('🔔 Git changes detected - Japanese gong played');
            } catch (error) {
                log(`Could not play notification sound: ${error}`);
            }
        }
        
        // COLUMN POSITION RESTORE - Rebuild content while preserving user's column position
        async function generateContentWithColumnRestore() {
            // Remember current column before rebuild (create a separate detection)
            const content = document.getElementById('content');
            const columns = content.querySelectorAll('.column');
            const scrollLeft = content.scrollLeft;
            
            // Find which column is closest to the current scroll position
            let savedColumn = 0;
            let closestDistance = Infinity;
            
            columns.forEach((column, index) => {
                const columnLeft = column.offsetLeft - 10; // Account for padding
                const distance = Math.abs(scrollLeft - columnLeft);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    savedColumn = index;
                }
            });
            
            log(`💾 Saving column position: ${savedColumn + 1} (scroll: ${scrollLeft}px)`);
            
            // Do full rebuild
            await generateContent(true);
            
            // Restore column position after rebuild
            setTimeout(() => {
                log(`🔄 Restoring to column: ${savedColumn + 1}`);
                jumpToColumn(savedColumn);
            }, 150); // Small delay to ensure layout is complete
        }
        
        // HANDLE GIT CHANGE EVENTS FROM CHOKIDAR - Respond to main process file system events
        async function handleGitChangeEvent() {
            const logMsg = `${new Date().toISOString()} - 🔄 RENDERER: Git change event received via chokidar IPC`;
            log(logMsg);
            
            // Log to file for debugging
            window.electronAPI?.executeCommand(`echo "${logMsg}" >> /tmp/git-client-renderer.log`);
            
            playNotificationBell();           // Play Japanese gong sound
            await generateContentWithColumnRestore(); // Rebuild with column position restore
        }
        
        // REGISTER CHOKIDAR EVENT LISTENER - Set up IPC communication with main process
        function registerChokidarListener() {
            if (window.electronAPI && window.electronAPI.ipcRenderer) {
                window.electronAPI.ipcRenderer.on('git-change-detected', handleGitChangeEvent);
                
                const logMsg = `${new Date().toISOString()} - 📡 RENDERER: Chokidar event listener registered successfully`;
                log(logMsg);
                window.electronAPI?.executeCommand(`echo "${logMsg}" >> /tmp/git-client-renderer.log`);
                
                return true;
            } else {
                const logMsg = `${new Date().toISOString()} - ⚠️ RENDERER: No IPC available - electronAPI missing`;
                log(logMsg);
                window.electronAPI?.executeCommand(`echo "${logMsg}" >> /tmp/git-client-renderer.log`);
                
                return false;
            }
        }
        
        // START EFFICIENT MONITORING - Set up chokidar event listener and initial load
        function startEfficientMonitoring() {
            // INITIAL LOAD - Force full build on startup
            generateContent(true).then(() => {
                log('🚀 Git client loaded with efficient chokidar file system watching');
                
                // REGISTER CHOKIDAR EVENT LISTENER
                const listenerRegistered = registerChokidarListener();
                
                if (listenerRegistered) {
                    log('✅ Complete chokidar integration active - watching .git/objects and .git/index');
                } else {
                    log('❌ Chokidar integration failed - falling back to manual refresh only');
                }
            });
        }

        // ====================================================================================
        // APPLICATION ENTRY POINT
        // ====================================================================================
        // Start everything when page loads
        window.addEventListener('load', startEfficientMonitoring);
    </script>
</body>
</html>